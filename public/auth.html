<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Log in </title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/504fbe512c.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/master.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel='shortcut icon' type='image/x-icon' href='assets/pac-man.ico' />

</head>
<body>

  <div class = "container-fluid">

    <div class = "container">
      <h1> Log In </h1>

      <form>

        <div class = "form-group">
          <input type="text" placeholder="School Student ID" class = "form-field" id = "studentid">
          <p class = "desc"> firstname.lastname + admission number
            <br/>
            eg: john.doe1234
          </p>
        </div>

        <div class="form-group">
          <input type="password" placeholder="House Password" class = "form-field" id = "pass">

          <p class = "desc"> ASK YOUR HOUSE CAPTAIN FOR YOUR PASSWORD </p>
        </div>

      </form>

      <button class="submit-btn btn" onclick = "login()">
        <span> Submit </span>
      </button>
      <!--
      <button class="submit-btn btn" onclick = "login()">
      <span href = "onboarding.html"> Submit </span>
    </button> -->


  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-database.js"></script>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


<script>

const firebaseConfig = {
  apiKey: "AIzaSyC7N1x5fSRjlPI5NuVnx1osDkvrchE5HoA",
  authDomain: "shri-teq-pac-man-48d1f.firebaseapp.com",
  databaseURL: "https://shri-teq-pac-man-48d1f-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "shri-teq-pac-man-48d1f",
  storageBucket: "shri-teq-pac-man-48d1f.appspot.com",
  messagingSenderId: "375352094557",
  appId: "1:375352094557:web:7ec64375d7412f24dec2b4",
  measurementId: "G-Q70295JKHZ"
};

firebase.initializeApp(firebaseConfig);

</script>

<script>

const loggedIn = getCookie("loggedIn");

if (loggedIn == "true") {
  window.location.replace("play.html");

}
const db = firebase.database();


function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}





function login() {
  const studentId = document.getElementById('studentid').value.toLowerCase();
  const userPass = document.getElementById('pass').value;


  const houseRef = db.ref("houses");
  const userRef = db.ref("users");
  var passValid = false;
  var userValid = false;

  var userHouseNewName = "";

  db.ref("houses").orderByChild("password").equalTo(userPass).once("value", function(houseSnapshot) {
    if (houseSnapshot.exists()) {
      passValid = true;
      console.log(houseSnapshot);
      userHouseNewName = Object.keys(houseSnapshot.val())[0];
      console.log(userHouseNewName);
      console.log(houseSnapshot.val());
      console.log(houseSnapshot.key);
    }
  }).then((value) => {

    db.ref("users").orderByChild("id").equalTo(studentId).once("value", function(userSnapshot) {
      if (userSnapshot.exists() && passValid) {
        userValid = true;
        var userId = "";
        var key = "";
        var userHouse = null;

        userSnapshot.forEach(function(onlyUserSnapshot) {
          userId = onlyUserSnapshot.val().id;
          userHouse = onlyUserSnapshot.val().house;
          key = onlyUserSnapshot.key;

        })

        if (!userHouse) {
          db.ref('users/' + String(key)).update({
            house: userHouseNewName

          });
        }

        document.cookie = "loggedIn=true";
        document.cookie = "house=" + userHouse;
        document.cookie = "userId=" + userId;

        window.location.replace("play.html");

      } else if (userSnapshot.exists() && !passValid) {
        userValid = true;
      }
    }).then(() => {
      if (!userValid && passValid) {
        swal("Incorrect username", "Make sure your username is in a valid format, firstname.lastname followed by admission number. For example, arjun.sharma6131. \n\nIf there continues to be an issue, contact adadarohan@gmail.com or 84488 14006 on WhatsApp")
      } else if (userValid && !passValid) {
        swal("Incorrect password", "Make sure you have obtained the correct password from your house captain. \n\nIf there continues to be an issue, contact adadarohan@gmail.com or 84488 14006 on WhatsApp")
      } else if (!userValid && !passValid) {
        swal("Incorrect username and password", "\nMake sure your username is in a valid format, firstname.lastname followed by admission number. For example, arjun.sharma6131.\n\n Make sure you have obtained the correct password from your house captain. \n\nIf there continues to be an issue, contact adadarohan@gmail.com or 84488 14006 on WhatsApp")
      }
    })
  })
}


</script>

</body>

</html>
